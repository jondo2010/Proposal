%
%	proposed_design.tex
%
%	Project Details: Proposed Design
%
%	John Hughes and Michael Jean
%	University of Manitoba
%

\chapter{Proposed Design}

%
% Engine Module
%

\section{Engine System}

The engine system consists of three sub-systems:

\begin{itemize}

\item the \emph{transmission} system, for shifting gears;

\item the \emph{starter} system, for starting the motor from dead stop; and

\item the \emph{intake management} system, for controlling the length of the intake runners.

\end{itemize}

These systems consist of a network of electromechanical actuators, sensors, and electronics. The control hardware is contained within the \emph{engine module}, which acts as the control centre for the engine system. This design pattern is common throughout the other vehicle systems, as will be demonstrated in later sections.

\begin{figure}[H]
	\centering
		\input{figures/engine_system_overview}
	\caption{Engine System Overview\label{fig:engine_system_overview}}
\end{figure}

\subsection{Transmission System}

Formula SAE cars designed at the University of Manitoba have utilized an electro-pneumatic shift actuation system for the past several years. This system is controlled electronically from the steering wheel by paddles. A compressed air cylinder is used to feed air to pneumaic pistons, which apply force to the levers on the clutch shaft and shift shaft. Binary solenoid valves apply pressure to either side of the pistons. 

In 2007, electronic control of the solenoid valves was realized by a set of switches on the steering wheel, which switched the low-current side of a set of relays. This in turn fed current to the valves, causing the pistons to move. In this system, the timing of the mechanical interaction with the transmission was entirely dependent on how long the driver held down the paddles. This required a lot of effort from the driver, and often resulted in missed shifts. It also caused heavy mechanical stress on the transmission. 

The 2008/2009 Formula SAE car improved on the 2007 design by replacing the relays with high-current solid state drivers. The timing signals to the solenoid valves were precisely controlled with an ARM7 microcontroller. Shift timing could be programmed, and no longer depended on how long the paddles were held. This  reduced the effort required from the driver and also reduced possible driver error.

Although an improvement from previous years, several inherent drawbacks to the 2008/2009 shift system exist. The air cylinder must be regularly refilled, which is a recurring expense. Air leaks were common, and air lines often came loose or melted after coming into contact with hot surfaces. 

The most serious drawback of the system is that the position of the cylinders is only binary or trinary. It is only possible to engage or disengage the clutch at a constant rate, determined by the pressure in the system, the flow rate through the valves, and the diameter of the piston. To launch the car, that is, in order to smoothly increase the momentum of the car from a stand-still, requires controlling the rate at which the clutch plates return into contact with each other. This level of control is not possible with a binary pneumatic system. In order to launch the car, a hand-lever was still required.

Our goal for the 2009/2010 transmission control is to further detask the driver, improve shift performance, and improve accuracy. To do so requires precise positioning of the clutch lever. This precision in control allows for a {}``partial-throttle launch'' without a hand-lever, and results in less mechanical strain on the clutch and transmission. 

\nomenclature{PWM}{Pulse Width Modulation}

Precise control of the clutch lever is accomplished with a fast solenoid valve controlled by a closed loop feedback system. The fast solenoid valves are controlled with \emph{Pulse Width Modulation} (PWM), which allows precise control of the air flow into the cylinder. Physical models of the entire pneumatic system are under development in collaboration with Jose M. Ricon Ruiz, a student in the faculty of Mechanical Engineering at the University of Manitoba. Mr. Ruiz has chosen to write his thesis report on this pneumatic system. 

Position feedback for the clutch and gear levers is provided by rotary potentiometers. Current gear position is determined with a potentiometer that is mechanically linked to the shift drum. Control and timing are generated by a microcontroller.

The shift lever does not require the same level of control as the clutch, but will utilize the same hardware to facilitate the possibility of using a stock shifting drum without gear position feedback.

Sizeable consideration was made for replacing the pneumatic system with a fully electronic one. However, it was determined that the power to weight ratio of electric motors and gearboxes was far less than that of a pneumatic solution for the amount of torque required.

\subsection{Starter System}

The starter solenoid is energized by signals from the engine controller. The driver may choose between an \emph{automatic} or \emph{manual} starting sequence. The \emph{driver interface module} (described in section \ref{sec:driver_interface}) relays the particular starting sequence command to the engine controller through the CAN bus.

The \emph{automatic} starting sequence will power the starter solenoid until either the engine starts or a timeout elapses. In this case, the timeout is five seconds. The \emph{manual} starting sequence will engage the starter for as long as the driver demands, much like holding the key in the start position in a standard consumer automobile ignition system. 

The starter feature will be disabled while the engine is running to avoid damaging the vehicle. The engine state can be determined by monitoring the current RPM.

\subsection{Intake Management System}

As mentioned in section \ref{sec:ice_overview}, much research has been put into the concept of a variable intake plenum. Engineers typically design the intake length to be optimal for torque at one specific RPM. We propose an intake system which allows for the length of runners to be dynamically changed at runtime. The intake runners will be lengthened or shortened at different RPM values. This will serve to widen the torque response of the engine over a larger range of RPMs. A servo mechanism will actuate a two-position variable intake plenum. As engine RPM changes, the servo is actuated accordingly to maximize torque output.

\subsection{Engine Module}

The \emph{engine module} is implemented on a custom PCB with an \emph{AT90CAN128} microcontroller from Atmel. All software for the microcontroller will be written in C and uploaded through a standard IEEE 1149.1 JTAG interface. 

In addition to the common life-support hardware for the microcontroller (such as the voltage regulator and decoupling capacitors), the engine module will include an SPI capable octal \emph{low-side solenoid driver}. This driver chip will switch the low side of the solenoid valves, as well as the starter solenoid. It includes flyback protection circuitry to squash voltage spikes from the inductive load of the solenoid, and can also detect electrical shorts. 

\begin{table}[H]
	\caption{Engine Module Components\label{tab:Engine-Module}}
	\centering
	\begin{tabular}{|c|c|c|}
		\hline 
		Part & Manufacturer & Part Number\tabularnewline
		\hline \hline
		CANBUS Transceiver & Microchip & MCP2551\tabularnewline 
		Microcontroller & Atmel & AT90CAN128\tabularnewline 
		Solenoid Driver & ST Microelectronics & L9822E\tabularnewline
		Voltage Regulator & Linear Technology & LT1129CST5\tabularnewline		
		\hline
	\end{tabular}
\end{table}

Besides controlling the transmission, starter, and intake management sub-systems, the engien controller software implements several driver control features:

\begin{description}

\item[Auto Upshift Feature]
This feature of the engine module is aimed primarily at improving performance in the acceleration event. Based on known torque curves, a table of optimal shift points in the RPM range will be identified. As the engine reaches the top RPM for a given gear, the engine module will automatically upshift to the next gear, without any driver input. All the driver needs to do is maintain full throttle, and hold on.

\item[Full-Throttle Launch]
Full-throttle launch uses an important feature of the ECU called launch control. From a stand-still, the slip ratio of the driven wheels to the non-driven wheels is monitored, and the engine output power is reduced until the ratio reaches 1:1. Drivers will use this feature by maintaining full-throttle at the starting line while holding the brake pedal. As soon as the brake pedal is released, the the engine module will release the clutch in a controlled manner in an attept to get the best possible acceleration.

\item[Part-Throttle Launch]
Part-throttle launch is a feature designed to mimick an automatic transmission. By controlling the clutch position, and thereby modulating the amount of torque transferred to the wheels for a short period of time, the car can be made to creep slowly from a standstill. This will be used when driving up to the starting line of various dynamic events.

\item[Neutral Find]
As drivers come in to the pits from driving the course, a useful feature is the ability for the car to shift the transmission back into neutral to avoid stalling the car. The neutral find feature will automatically downshift the transmission repeatedly until it finds neutral.

\end{description}

%
% Brake Module
%

\section{Brake Module}

Electronic control of the brake bias is realized with the addition of the \emph{brake module}. Drivers may adjust the brake bias from cockpit controls, allowing different drivers to {}``dial-in'' their preferred bias setting.

\subsection{Mechanical}

To achieve our goals with the brake bias in the 2009/2010 car, we will design and manufacture a braking module which will be able to adjust the bias bar. A stepper motor will be linked to the bar. Automatic calibration is enabled by sensing the furthest extents in both directions of the bias bar. Microswitches will signal the module when the bar has reached an outer limit.

\subsection{Hardware}

The brake module will be implemented on a custom PCB with the same AT90CAN128 microcontroller common to the other modules. In addition to the common life-support hardware, the brake module will include . The hardware architecture for the brake module can be seen in Figure \ref{fig:Engine-Module-Overview}.

\subsection{Software}

%
% Wireless Telemetry
%
\section{Wireless Telemetry Module}

The ability to communicate with the car wirelessly is a very important feature of most current FSAE designs. There are various systems in the University of Manitoba's Formula SAE car that are important to interface with remotely, including the ECU and the DAQ. Both the ECU and the DAQ hardware provide a wired RS232 interface to a Windows PC running proprietary software that communicates with each device. Each software expects to talk directly to the device through a Windows COM port.

Our goal with the wireless telemetry for the 2009/2010 car is to multiplex the two serial streams, and send the data wirelessly using an XBee modem to multiple different receiver laptops using a receiver modem. A small software driver will split the two data streams apart, and dump the data into two different virtual serial ports on the PC. The goal with this is that the driver will allow proprietary software to run transparently without any modifications. A block diagram of the telemetry system can be seen in Figure \ref{fig:Wireless-Telemetry-Overview}.

A secondary goal for the telemetry system is to be able to decode and re-encode the serial stream from the DAQ. This will allow us to send data from the DAQs sensors, such as GPS and accelerometer data 

\subsection{Hardware}
The telemetry module will be implemented on a custom PCB with the same AT90CAN128 microcontroller common to the other modules. In addition to the common life-support hardware, the telemetry module will also include a dual RS232 trasceiver chip and 2 DSub9 connectors. The ECU and the DAQ will connect with the telemetry board with standard 9-pin serial cables. While the RS232 transceiver will interface with the AT90CAN's 2 built-in USART ports, a third UART will be needed to interface with an XBee Pro wireless modem. For this, the telemetry module will include an SPI interfaceable UART chip.

The XBee Pro Modems from Digi International require a 3.3V power supply, and consume at most 215mA of current during transmit. Since the common module hardware provides power for only 5V devices, the telemetry module will have a second LDO regulator providing 3.3V.

  \begin{figure}[H]
    \begin{centering}
      \input{figures/telemetry_module_overview}
    \end{centering}

    \caption{Wireless Telemetry Overview\label{fig:Wireless-Telemetry-Overview}}
  \end{figure}

  \begin{table}[H]
    \caption{Wireless Telemetry Module Components\label{tab:Wireless-Telemetry-Module}}
    \begin{centering}
      \begin{tabular}{|c|c|c|}
	\hline 
	Part & Description & Part Number\tabularnewline
	\hline
	\hline
	Wireless Modem & XBee-PRO OEM Module & XBee-PRO\tabularnewline
	\hline 
	RS232 Transciever & Dual RS232 Trasciever & MAX232\tabularnewline
	\hline 
	SPI-UART & Additional SPI interfacable UART chip &
MAX3100\tabularnewline
	\hline 
	3v3 LDO & 300mA Low Dropout Regulator & LT1521\tabularnewline
	\hline
      \end{tabular}
    \end{centering}
  \end{table}

\subsection{Software}

%
%	Driver Interface Module
%

\section{Driver Interface Module}
\nomenclature{LCD}{Liquid Crystal Display}

A major design concern with the Formula SAE car is driver control and feedback. In previous years, the team has often been hindered by a lack of direct information from the electronic systems in the car. While the team will benefit from having wireless telemetry data available, it will be beneficial to get diagnostics directly from the car, as well as inform the driver about current data.

Our goal for the 2009/2010 car's driver interface is to have a large monochrome \emph{Liquid Crystal Display} (LCD) screen inset in the steering wheel providing real-time information to the driver about all the electronic systems in the car. The LCD module will be an off the shelf module complete with controller, character RAM, and LCD drivers. It will provide an 8-bit parallel interface to the microcontroller. Primary information that we want to display to the driver consists of:
\begin{itemize}
\item Current gear;
\item Current vehicle dynamics mode;
\item Telemetry signal strength;
\item Engine RPM;
\item Vehicle wheelspeed;
\item Launch control status.
\end{itemize}
Additional information can be displayed by paging through information screens with a push button.

We also want to be able to change various run-time parameters through the driver interface.

\begin{table}[H]
\caption{Steering Wheel Components\label{tab:Steering-Wheel-Components}}

\centering{}\begin{tabular}{|c|>{\centering}p{15em}|c|}
\hline 
Part & Description & Part Number\tabularnewline
\hline
\hline 
LCD Screen & Newhaven Display 320x240 Monochrome, Transflective, LCD & NHD-320240WX\tabularnewline
\hline 
LCD Controller & RAiO Dot Matrix LCD Controller & RA8835\tabularnewline
\hline 
Rotary Dials & Bourns Inc. ECW detented rotary encoder & ECW1J-B24-BC0024L-ND\tabularnewline
\hline
\end{tabular}
\end{table}

\subsection{Mechanical}
\subsection{Hardware}
\subsection{Software}

\subsection{Vehicle Dynamics Mode (VDM)}
\nomenclature{VDM}{Vehicle Dynamics Mode}

As part of the overall software control system, we want to implement a method of quickly modifying system behaviour, and several dynamic vehicle parameters quickly and easily. For example, during the acceleration event at competition, we want to enable launch control, enable auto-upshift, and perhaps have a firmer suspension setting. This will be possible all in one step by changing the Vehicle Dynamics Mode to {}``acceleration''. All nodes on the network will be synchronized to modify their parameters in accordance with the specific mode.
\begin{description}
  \item [{PitMode}] Enables soft-launch driving characteristics that mimic a fully automatic transmission. This makes slowly driving the car forward from a standstill far easier, and only requires the driver to take his left foot off the brake, and slightly apply the throttle.
  \item [{AccelMode}] Puts the cars' systems into full-performance characteristics. Launch control is activated. The transmission controller will watch for a launch signal from the driver, and will automatically up-shift based on the engine RPM.
  \item [{DynamicMode}] Will put the cars' systems into a mode that is suitable for the autocross, and the endurance race.
\end{description}
The different parameters for all the possible modes will be stored in flash in each of the specific modules. Once a module receives a mode change message, it is its responsibility to modify its behavior to match the requested mode. It will be possible to modify the parameters stored on the node on-the-fly through the driver interface.

\section{Network Tester}
\nomenclature{CAN}{Controller Area Network}

To achieve our testability goals, we will design and manufacture an independent \emph{Controller Area Network} (CAN) network tester module to allow us to interface directly with individual nodes on the network, and to test parts of the system independently of one another. The network tester will consist of a PC-interfaceable micro-controller that will run a set of test suites. Each test suite will test all functions of a given module by sending and receiving the expected messages on the network to the module. This will greatly ease the development and debugging of the software on each node.
