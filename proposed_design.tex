%
%	proposed_design.tex
%
%	Project Details: Proposed Design
%
%	John Hughes and Michael Jean
%	University of Manitoba
%

\section{Proposed Design}

%
%		Engine Module
%
\subsection{Engine Module}

\subsubsection{Transmission}

Formula SAE cars designed at the University of Manitoba have for the past several years utilized an electro-pneumatic shifting actuation system, controlled electronically from the steering wheel by paddle switches. A compressed air cylinder is used to feed air to pneumaic pistons which apply force to the levers on the clutch and shift shafts on the transmission. Air to the pistons is controlled by binary solenoid valves which apply pressure to either side of the piston. In 2007, the electronic control of the solenoid valves was realized with a set of switches on the steering wheel which switched the low-current side of a set of relays, which in turn fed current to the valves. In this system, the timing of the mechanical interaction with the transmission was entirely dependent on how long the driver held down the paddles for, which required a lot of effort for the driver, and often resulted in missed shifts, and was mechanically hard on the transmission. The 2008/2009 Formula SAE car improved the design by replacing the relays with high-current solid state drivers, and precicely controlled the timing signals to the solenoid valves with a state machine on an ARM7 microcontroller. This avoided a lot of possible driver error, as shift timing could be programmed and did not depend on how long the paddles were held.

Yet several inherent drawbacks to the 2008/2009 shift system still existed. The nature of the pneumatic systems required that the air cylinder be regularly refilled, a recurring expense, and the team had many problems with air leaks and air lines coming loose or coming into contact with hot surfaces and melting. A major drawback of of the system is that the position of the cylinders is only binary or trinary. In the case of the clutch, it is only possible to engage, or disengage, at a constant rate determined by the pressure in the system, the flow rate through the valves, and the diameter of the piston. Because of this, it was not feasable to use the pneumatic actuation for launching the car, which requires {}``feathering'' of the clutch, or controlling the rate that the clutch plates return into contact with each other, in order to increase the momentum of the car from a stand-still. In order to launch the car, a hand-lever was still required.

Our goal for the 2009/2010 transmission control is to further detask the driver, improve shift performance, and improve accuracy. We will maintain timing, while allow for precise positioning of the clutch and shift levers. This will in turn allow for a {}``partial-throttle launch'' without a hand-lever, and be mechanically less strenuous on the clutch and transmission. We also want to have feedback mechanisms for the clutch and gear lever positioning, and indexed-feedback for the current gear position. This will allow us to positively determine if a shift was successful, and to know which gear the transmission currently is in.

In order to achieve our goals with the transmission control, we will develop a closed loop control system for the clutch position actuator, and control air into the cylinder by using a fast PWM valve instead of a slow binary one. Physical models of the entire pneumatic system will be determined in collaboration with Jose M. Ricon Ruiz, a student in the faculty of mechanical engineering who will be doing his thesis project on the subject. Position feedback will be provided by rotary potentiometers. Current gear position will be determined with a potentiometer mechanically linked to the shift drum in the transmission. Timing signals, as well as control software will be implemented at several levels on a microcontroller.

A sizeable effort and analysis was made in consideration of replacing the pneumatic system with a fully electronic one. It was determined however that for the amount of torque required, the power to weight ratio of electric motors and gearboxes was far less than that of a pneumatic solution.

\subsubsection{Variable Intake Plenum}

A fair amount of research has been done in previous years on the intake and exhaust design for the Formla SAE car. Lucas Groening wrote his undergraduate thesis on modelling of the engine package for the 2008 car. One important dynamic aspect of the engine design that he describes is the effect of the intake runner length on the torque output of the engine at different RPM \cite{Modelingof20}.

The intake consists of several parts. The throttlebody, which is a valve that serves to control the amount of air entering the intake system is followed by a restrictor, which restricts the maximum air flow into the engine. The restrictor is a requirement in the Formula SAE rules. After the restrictor the air flows into a large plenum, off of which 4 intake runners lead to each cylinder head, containing the valves.

As the intake valves on the engine open, they generate negative pressure waves that travel the length of the intake runners back into the intake plenum, and there they reflect and travel back towards the intake valve. This effect of reflecting and bouncing back towards the intake valves can act to increase pressure at the valve and increase power. The timing of the returning pressure wave however is critical, as one wants the wave to reach the valve again just as it is opening for maximum effect. The length of time required for the waves to travel the length of the intake runners depends on the length of the runners. At different RPMs, the valves are opening and closing at different speeds, therefore for any fixed intake length, i.e., fixed amount of time for the negative waves to travel the length of the runners twice, there is an RPM that results in maximum torque \cite{Modelingof20}. The same effects can also be observed on the exhaust side of the engine.

Engineers typically design the intake length to be optimal at a specific RPM. An improvement proposed by the team this year is to design an intake system which allows for the length of runners to be dynamically changed at runtime. At different RPMs, the intake runners will be either lengthened or shortened, based on data obtained through engine simulation. This will serve to widen the torque response of the engine over a larger range of RPMs. In order to realise this goal, an electromechanical control system will need to be developed to actuate the variable intake.

We will develop a servo mechanism that will actuate a two-position variable intake plenum. It will react to changes in RPM, and actuate accordingly.

\subsubsection{Hardware}

The engine module will be implemented on a custom PCB with the same AT90CAN128 microcontroller common to the other modules. In addition to the common life-support hardware, the engine module will include an SPI interfaceable octal low-side solenoid driver. This driver chip will switch the low side of the solenoid valves, as well as the starter solenoid. It includes flyback protection circuitry, and can detect electrical shorts. The hardware architecture for the Engine Module can be seen in Figure \ref{fig:Engine-Module-Overview}.

  \begin{figure}[H]
    \begin{centering}
      \input{figures/engine_module_overview}
    \end{centering}

    \caption{Engine Module Overview\label{fig:Engine-Module-Overview}}
  \end{figure}

  \begin{centering}
  \begin{table}[H]
    \caption{Engine Module Components\label{tab:Engine-Module}}
      \begin{tabular}{|c|c|c|}
	\hline 
	Part & Description & Part Number\tabularnewline
	\hline
	\hline
	Solenoid Driver & Octal Serial Solenoid Driver & L9822E\tabularnewline
	\hline
      \end{tabular}
  \end{table}
  \end{centering}


\subsubsection{Software}

\paragraph{Auto Upshift Feature}
This feature of the engine module is aimed primarily at improving performance in the acceleration event. Based on known torque curves, a table of optimal shift points in the RPM range will be identified. As the engine reaches the top RPM for a given gear, the engine module will automatically upshift to the next gear, without any driver input. All the driver needs to do is maintain full throttle, and hold on.

\paragraph{Full-throttle Launch}
Full-throttle launch uses an important feature of the ECU called launch control. From a stand-still, the slip ratio of the driven wheels to the non-driven wheels is monitored, and the engine output power is reduced until the ratio reaches 1:1. Drivers will use this feature by maintaining full-throttle at the starting line while holding the brake pedal. As soon as the brake pedal is released, the the engine module will release the clutch in a controlled manner in an attept to get the best possible acceleration.

\paragraph{Part-throttle Launch}
Part-throttle launch is a feature designed to mimick an automatic transmission. By controlling the clutch position, and thereby modulating the amount of torque transferred to the wheels for a short period of time, the car can be made to creep slowly from a standstill. This will be used when driving up to the starting line of various dynamic events.

\paragraph{Neutral Find}
As drivers come in to the pits from driving the course, a useful feature is the ability for the car to shift the transmission back into neutral to avoid stalling the car. The neutral find feature will automatically downshift the transmission repeatedly until it finds neutral.

\paragraph{Anti-Stall}


%
%		Brake Module
%
\subsection{Brake Module}

As dictated by the competition rules, all Formula SAE cars must have 4-wheel hyraulic brakes. The braking system must be composed of 2 independent hydraulic circuits \cite{2010fsaerules}. Typically all designs seperate the front and rear braking circuits, and link the two together to the brake pedal with a {}``bias bar''. This bar serves to transmit force from the applied brake pedal proportionately to both hydraulic cylinders. The amount of braking force front-to-back can therefore be adjusted by adjusting the bias bar. The bias bar in the University of Manitoba's Formula SAE design is a threaded rod, and is adjusted by rotation.

The front-to-back brake bias is an important dynamic characteristic of the car. The car must be able to {}``lock'' all 4 tires under heavy braking, as specified in the rules. Different drivers also prefer slightly more bias front or rearwards. Adjusting the brake bias in virtually all previous generations of UofM Formula SAE cars required removing body panels, or the front nose cone, and manually turning a knob on the bias bar. Finding an appropriate setting for brake bias was a tedious trial and error exercise, as drivers had to run a lap in the car, brake heavily, and then return to the team so that the body could be removed and the bias adjusted. This is a very lengthy feedback loop in adjustability.

Our goal for the 2009/2010 car is to enable electronic control of the brake bias with the addition of a brake module. We want to allow drivers to be able to adjust the brake bias from cockpit controls, and to quantify the brake bias as a percentage front-to-back, allowing different drivers to {}``dial-in'' their preferred bias setting.

\subsubsection{Mechanical}

To achieve our goals with the brake bias in the 2009/2010 car, we will design and manufacture a braking module which will be able to adjust the bias bar. A stepper motor will be linked to the bar. Automatic calibration is enabled by sensing the furthest extents in both directions of the bias bar. Microswitches will signal the module when the bar has reached an outer limit.

\subsubsection{Hardware}

The brake module will be implemented on a custom PCB with the same AT90CAN128 microcontroller common to the other modules. In addition to the common life-support hardware, the brake module will include . The hardware architecture for the brake module can be seen in Figure \ref{fig:Engine-Module-Overview}.

\subsubsection{Software}

%
%		Wireless Telemetry
%
\subsection{Wireless Telemetry Module}

The ability to communicate with the car wirelessly is a very important feature of most current FSAE designs. There are various systems in the University of Manitoba's Formula SAE car that are important to interface with remotely, including the ECU and the DAQ. Both the ECU and the DAQ hardware provide a wired RS232 interface to a Windows PC running proprietary software that communicates with each device. Each software expects to talk directly to the device through a Windows COM port.

Our goal with the wireless telemetry for the 2009/2010 car is to multiplex the two serial streams, and send the data wirelessly using an XBee modem to multiple different receiver laptops using a receiver modem. A small software driver will split the two data streams apart, and dump the data into two different virtual serial ports on the PC. The goal with this is that the driver will allow proprietary software to run transparently without any modifications. A block diagram of the telemetry system can be seen in Figure \ref{fig:Wireless-Telemetry-Overview}.

A secondary goal for the telemetry system is to be able to decode and re-encode the serial stream from the DAQ. This will allow us to send data from the DAQs sensors, such as GPS and accelerometer data 

\subsubsection{Hardware}
The telemetry module will be implemented on a custom PCB with the same AT90CAN128 microcontroller common to the other modules. In addition to the common life-support hardware, the telemetry module will also include a dual RS232 trasceiver chip and 2 DSub9 connectors. The ECU and the DAQ will connect with the telemetry board with standard 9-pin serial cables. While the RS232 transceiver will interface with the AT90CAN's 2 built-in USART ports, a third UART will be needed to interface with an XBee Pro wireless modem. For this, the telemetry module will include an SPI interfaceable UART chip.

The XBee Pro Modems from Digi International require a 3.3V power supply, and consume at most 215mA of current during transmit. Since the common module hardware provides power for only 5V devices, the telemetry module will have a second LDO regulator providing 3.3V.

  \begin{figure}[H]
    \begin{centering}
      \input{figures/telemetry_module_overview}
    \end{centering}

    \caption{Wireless Telemetry Overview\label{fig:Wireless-Telemetry-Overview}}
  \end{figure}

  \begin{table}[H]
    \caption{Wireless Telemetry Module
Components\label{tab:Wireless-Telemetry-Module}}
    \begin{centering}
      \begin{tabular}{|c|c|c|}
	\hline 
	Part & Description & Part Number\tabularnewline
	\hline
	\hline
	Wireless Modem & XBee-PRO OEM Module & XBee-PRO\tabularnewline
	\hline 
	RS232 Transciever & Dual RS232 Trasciever & MAX232\tabularnewline
	\hline 
	SPI-UART & Additional SPI interfacable UART chip &
MAX3100\tabularnewline
	\hline 
	3v3 LDO & 300mA Low Dropout Regulator & LT1521\tabularnewline
	\hline
      \end{tabular}
    \end{centering}
  \end{table}

\subsubsection{Software}

%
%	Driver Interface Module
%

\subsection{Driver Interface Module}
\nomenclature{LCD}{Liquid Crystal Display}

A major design concern with the Formula SAE car is driver control and feedback. In previous years, the team has often been hindered by a lack of direct information from the electronic systems in the car. While the team will benefit from having wireless telemetry data available, it will be beneficial to get diagnostics directly from the car, as well as inform the driver about current data.

Our goal for the 2009/2010 car's driver interface is to have a large monochrome \emph{Liquid Crystal Display} (LCD) screen inset in the steering wheel providing real-time information to the driver about all the electronic systems in the car. The LCD module will be an off the shelf module complete with controller, character RAM, and LCD drivers. It will provide an 8-bit parallel interface to the microcontroller. Primary information that we want to display to the driver consists of:
\begin{itemize}
\item Current gear;
\item Current vehicle dynamics mode;
\item Telemetry signal strength;
\item Engine RPM;
\item Vehicle wheelspeed;
\item Launch control status.
\end{itemize}
Additional information can be displayed by paging through information screens with a push button.

We also want to be able to change various run-time parameters through the driver interface.

\begin{table}[H]
\caption{Steering Wheel Components\label{tab:Steering-Wheel-Components}}

\centering{}\begin{tabular}{|c|>{\centering}p{15em}|c|}
\hline 
Part & Description & Part Number\tabularnewline
\hline
\hline 
LCD Screen & Newhaven Display 320x240 Monochrome, Transflective, LCD & NHD-320240WX\tabularnewline
\hline 
LCD Controller & RAiO Dot Matrix LCD Controller & RA8835\tabularnewline
\hline 
Rotary Dials & Bourns Inc. ECW detented rotary encoder & ECW1J-B24-BC0024L-ND\tabularnewline
\hline
\end{tabular}
\end{table}

\subsubsection{Mechanical}
\subsubsection{Hardware}
\subsubsection{Software}

\subsubsection{Vehicle Dynamics Mode (VDM)}
\nomenclature{VDM}{Vehicle Dynamics Mode}

As part of the overall software control system, we want to implement a method of quickly modifying system behaviour, and several dynamic vehicle parameters quickly and easily. For example, during the acceleration event at competition, we want to enable launch control, enable auto-upshift, and perhaps have a firmer suspension setting. This will be possible all in one step by changing the Vehicle Dynamics Mode to {}``acceleration''. All nodes on the network will be synchronized to modify their parameters in accordance with the specific mode.
\begin{description}
  \item [{PitMode}] Enables soft-launch driving characteristics that mimic a fully automatic transmission. This makes slowly driving the car forward from a standstill far easier, and only requires the driver to take his left foot off the brake, and slightly apply the throttle.
  \item [{AccelMode}] Puts the cars' systems into full-performance characteristics. Launch control is activated. The transmission controller will watch for a launch signal from the driver, and will automatically up-shift based on the engine RPM.
  \item [{DynamicMode}] Will put the cars' systems into a mode that is suitable for the autocross, and the endurance race.
\end{description}
The different parameters for all the possible modes will be stored in flash in each of the specific modules. Once a module receives a mode change message, it is its responsibility to modify its behavior to match the requested mode. It will be possible to modify the parameters stored on the node on-the-fly through the driver interface.

\subsection{Network Tester}
\nomenclature{CAN}{Controller Area Network}

To achieve our testability goals, we will design and manufacture an independent \emph{Controller Area Network} (CAN) network tester module to allow us to interface directly with individual nodes on the network, and to test parts of the system independently of one another. The network tester will consist of a PC-interfaceable micro-controller that will run a set of test suites. Each test suite will test all functions of a given module by sending and receiving the expected messages on the network to the module. This will greatly ease the development and debugging of the software on each node.